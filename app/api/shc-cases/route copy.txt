import { NextRequest, NextResponse } from 'next/server';
import * as cheerio from 'cheerio';

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const advocateCode = searchParams.get('advocateCode') || '29694';
  const page = parseInt(searchParams.get('page') || '1');
  const city = searchParams.get('city') || 'khi';
  const caseNum = searchParams.get('caseNum') || '';
  const caseYear = searchParams.get('caseYear') || '';

 
// const url = `https://cases.shc.gov.pk/khi/web/index.php?r=cases%2Fsearch-result&CasesSearch%5BCASENO%5D=&CasesSearch%5BCASEYEAR%5D=&CasesSearch%5BCASENAMECODE%5D=&CasesSearch%5BBENCH%5D=&CasesSearch%5BCIRCUITCODE%5D=&CasesSearch%5BMATTERCODE%5D=&CasesSearch%5BPARTY%5D=&CasesSearch%5BGOVT_AGENCY_CODE%5D=&CasesSearch%5BFIRNO%5D=&CasesSearch%5BFIRYEAR%5D=&CasesSearch%5BPOLICESTATIONCODE%5D=&CasesSearch%5BADVOCATECODE%5D=29694&CasesSearch%5BisPending%5D=&CasesSearch%5BisPending%5D=3&CasesSearch%5BCASENO%5D=&CasesSearch%5BCASEYEAR%5D=2023&CasesSearch%5BCASENAMECODE%5D=&CasesSearch%5BBENCH%5D=&CasesSearch%5BCIRCUITCODE%5D=&CasesSearch%5BMATTERCODE%5D=&CasesSearch%5BPARTY%5D=&CasesSearch%5BGOVT_AGENCY_CODE%5D=&CasesSearch%5BADVOCATECODE%5D=29694&CasesSearch%5BFIRNO%5D=&CasesSearch%5BFIRYEAR%5D=&CasesSearch%5BPOLICESTATIONCODE%5D=&CasesSearch%5BisPending%5D=&CasesSearch%5BisPending%5D=3`

 const params = new URLSearchParams();

  if (caseNum) params.append('CasesSearch[CASENO]', caseNum);
  if (caseYear) params.append('CasesSearch[CASEYEAR]', caseYear);
  
  params.append('CasesSearch[ADVOCATECODE]', advocateCode);
  params.append('CasesSearch[isPending]', '3');
  params.append('page', page.toString());

  // ✅ Construct final URL safely
  const url = `https://cases.shc.gov.pk/${city}/web/index.php?r=cases%2Fsearch-result&${params.toString()}`;

  console.log('🔍 Final SHC URL:', url);

  
//   let caseNumParam = ''
//   let caseYearParam = ''
//   if(caseNum !== ""){
//     caseNumParam = `CasesSearch%5BCASENO%5D=${caseNum}&`
//   }

//   if(caseYear !== ""){
//     caseYearParam = `CasesSearch%5BCASEYEAR%5D=${caseYear}&`
//   }
   
//   const url = `https://cases.shc.gov.pk/${city}/web/index.php?r=cases%2Fsearch-result&${caseNumParam}${caseYearParam}&CasesSearch%5BADVOCATECODE%5D=${advocateCode}&CasesSearch%5BisPending%5D=3&page=${page}`;
  
  try {
    const response = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const html = await response.text();
    const $ = cheerio.load(html);
    
    const cases: any[] = [];
    
    // Parse the table rows
    $('table tbody tr').each((index, element) => {
      const row = $(element);
      const cells = row.find('td');
      
      if (cells.length > 0) {
        // Extract the case ID from the View button link
        const viewLink = cells.last().find('a').attr('href') || '';
        const idMatch = viewLink.match(/id=(\d+)/);
        const caseId = idMatch ? idMatch[1] : null;
        
        cases.push({
          srNo: cells.eq(0).text().trim(),
          caseType: cells.eq(1).text().trim(),
          caseNo: cells.eq(2).text().trim(),
          caseYear: cells.eq(3).text().trim(),
          bench: cells.eq(4).text().trim(),
          circuit: cells.eq(5).text().trim(),
          parties: cells.eq(6).text().trim(),
          matter: cells.eq(7).text().trim(),
          institutionDate: cells.eq(8).text().trim(),
          lastDate: cells.eq(9).text().trim(),
          nextDate: cells.eq(10).text().trim(),
          status: cells.eq(11).text().trim(),
          caseId: caseId
        });
      }
    });
    
    // Check for pagination info
    const paginationText = $('.pagination .active').text().trim();
    const summaryText = $('.summary').text().trim();
    
    // Try to extract total count from summary text like "Showing 1-20 of 150 results"
    let totalCount = 0;
    const totalMatch = summaryText.match(/of\s+(\d+)/i);
    if (totalMatch) {
      totalCount = parseInt(totalMatch[1]);
    }
    
    // Check if there's a next page
    const hasNextPage = $('ul.pagination li.next:not(.disabled)').length > 0;
    const hasPrevPage = $('ul.pagination li.prev:not(.disabled)').length > 0;
    
    return NextResponse.json({ 
      success: true, 
      data: cases,
      count: cases.length,
      currentPage: page,
      hasNextPage,
      hasPrevPage,
      totalCount: totalCount || null
    });
    
  } catch (error) {
    console.error('Error fetching SHC cases:', error);
    return NextResponse.json(
      { success: false, error: 'Failed to fetch cases' },
      { status: 500 }
    );
  }
}

// import { NextRequest, NextResponse } from 'next/server';
// import * as cheerio from 'cheerio';


// export async function GET(request: NextRequest) {
//   const searchParams = request.nextUrl.searchParams;
//   const advocateCode = searchParams.get('advocateCode') || '29694';
//   const page = parseInt(searchParams.get('page') || '1');
//   const city = searchParams.get('city') || 'khi';
//   const caseNum = searchParams.get('caseNum') || '';
//   const caseYear = searchParams.get('caseYear') || '';
//   const allRecords = searchParams.get('all') === 'true';

//   const params = new URLSearchParams();

//   if (caseNum) params.append('CasesSearch[CASENO]', caseNum);
//   if (caseYear) params.append('CasesSearch[CASEYEAR]', caseYear);
  
//   params.append('CasesSearch[ADVOCATECODE]', advocateCode);
//   params.append('CasesSearch[isPending]', '3');

//   // If allRecords is requested, we'll fetch all pages
//   if (!allRecords) {
//     params.append('page', page.toString());
//   }

//   const baseUrl = `https://cases.shc.gov.pk/${city}/web/index.php?r=cases%2Fsearch-result&${params.toString()}`;

//   console.log('🔍 Final SHC URL:', allRecords ? 'Fetching ALL pages' : baseUrl);

//   try {
//     let allCases: any[] = [];
//     let currentPage = 1;
//     let hasMorePages = true;
//     let totalCount = 0;

//     // Fetch all pages if allRecords is true, otherwise just fetch the requested page
//     do {
//       const url = allRecords 
//         ? `${baseUrl}&page=${currentPage}`
//         : baseUrl;

//       const response = await fetch(url, {
//         headers: {
//           'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
//         }
//       });
      
//       if (!response.ok) {
//         throw new Error(`HTTP error! status: ${response.status}`);
//       }
      
//       const html = await response.text();
//       const $ = cheerio.load(html);
      
//       // Parse the table rows
//       $('table tbody tr').each((index, element) => {
//         const row = $(element);
//         const cells = row.find('td');
        
//         if (cells.length > 0) {
//           // Extract the case ID from the View button link
//           const viewLink = cells.last().find('a').attr('href') || '';
//           const idMatch = viewLink.match(/id=(\d+)/);
//           const caseId = idMatch ? idMatch[1] : null;
          
//           allCases.push({
//             srNo: cells.eq(0).text().trim(),
//             caseType: cells.eq(1).text().trim(),
//             caseNo: cells.eq(2).text().trim(),
//             caseYear: cells.eq(3).text().trim(),
//             bench: cells.eq(4).text().trim(),
//             circuit: cells.eq(5).text().trim(),
//             parties: cells.eq(6).html()?.trim() || cells.eq(6).text().trim(),
//             matter: cells.eq(7).text().trim(),
//             institutionDate: cells.eq(8).text().trim(),
//             lastDate: cells.eq(9).text().trim(),
//             nextDate: cells.eq(10).text().trim(),
//             status: cells.eq(11).html()?.trim() || cells.eq(11).text().trim(),
//             caseId: caseId
//           });
//         }
//       });

//       // For all records mode, check if there are more pages
//       if (allRecords) {
//         // Check for pagination info on first page
//         if (currentPage === 1) {
//           const summaryText = $('.summary').text().trim();
//           const totalMatch = summaryText.match(/of\s+(\d+)/i);
//           if (totalMatch) {
//             totalCount = parseInt(totalMatch[1]);
//           }
//         }

//         // Check if there's a next page
//         const hasNextPage = $('ul.pagination li.next:not(.disabled)').length > 0;
//         hasMorePages = hasNextPage;
//         currentPage++;

//         // Add a small delay to avoid overwhelming the server
//         if (hasMorePages) {
//           await new Promise(resolve => setTimeout(resolve, 500));
//         }
//       } else {
//         // Single page mode - just get pagination info
//         const summaryText = $('.summary').text().trim();
//         const totalMatch = summaryText.match(/of\s+(\d+)/i);
//         if (totalMatch) {
//           totalCount = parseInt(totalMatch[1]);
//         }
//         hasMorePages = false;
//       }
//     } while (allRecords && hasMorePages);

//     const $ = cheerio.load(html);
// const hasNextPage = $('ul.pagination li.next:not(.disabled)').length > 0;
// const hasPrevPage = $('ul.pagination li.prev:not(.disabled)').length > 0;
    
//     return NextResponse.json({ 
//       success: true, 
//       data: allCases,
//       count: allCases.length,
//       currentPage: allRecords ? 1 : page,
//       hasNextPage,
//       hasPrevPage,
//       totalCount: totalCount || allCases.length,
//       fetchedAll: allRecords
//     });
    
//   } catch (error) {
//     console.error('Error fetching SHC cases:', error);
//     return NextResponse.json(
//       { success: false, error: 'Failed to fetch cases' },
//       { status: 500 }
//     );
//   }
// }


// import { NextRequest, NextResponse } from 'next/server';
// import * as cheerio from 'cheerio';

// export async function GET(request: NextRequest) {
//   const searchParams = request.nextUrl.searchParams;
//   const advocateCode = searchParams.get('advocateCode') || '29694';
//   const city = searchParams.get('city') || 'khi';
//   const caseNum = searchParams.get('caseNum') || '';
//   const caseYear = searchParams.get('caseYear') || '';

//   const params = new URLSearchParams();

//   if (caseNum) params.append('CasesSearch[CASENO]', caseNum);
//   if (caseYear) params.append('CasesSearch[CASEYEAR]', caseYear);
//   params.append('CasesSearch[ADVOCATECODE]', advocateCode);
//   params.append('CasesSearch[isPending]', '3');

//   const baseUrl = `https://cases.shc.gov.pk/${city}/web/index.php?r=cases%2Fsearch-result`;

//   console.log('🔍 Base URL:', `${baseUrl}&${params.toString()}`);

//   let page = 1;
//   let hasNextPage = true;
//   const allCases: any[] = [];

//   try {
//     while (hasNextPage) {
//       const url = `${baseUrl}&${params.toString()}&page=${page}`;
//       console.log(`🧭 Fetching Page ${page}: ${url}`);

//       const response = await fetch(url, {
//         headers: {
//           'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
//         }
//       });

//       if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

//       const html = await response.text();
//       const $ = cheerio.load(html);

//       // Parse case rows
//       $('table tbody tr').each((_, el) => {
//         const row = $(el);
//         const cells = row.find('td');
//         if (cells.length > 0) {
//           const viewLink = cells.last().find('a').attr('href') || '';
//           const idMatch = viewLink.match(/id=(\d+)/);
//           const caseId = idMatch ? idMatch[1] : null;

//           allCases.push({
//             srNo: cells.eq(0).text().trim(),
//             caseType: cells.eq(1).text().trim(),
//             caseNo: cells.eq(2).text().trim(),
//             caseYear: cells.eq(3).text().trim(),
//             bench: cells.eq(4).text().trim(),
//             circuit: cells.eq(5).text().trim(),
//             parties: cells.eq(6).text().trim(),
//             matter: cells.eq(7).text().trim(),
//             institutionDate: cells.eq(8).text().trim(),
//             lastDate: cells.eq(9).text().trim(),
//             nextDate: cells.eq(10).text().trim(),
//             status: cells.eq(11).text().trim(),
//             caseId,
//           });
//         }
//       });

//       // Detect next page
//       hasNextPage = $('ul.pagination li.next:not(.disabled)').length > 0;
//       console.log(`📄 Page ${page} done. hasNextPage=${hasNextPage}`);

//       page++;
//       await new Promise(res => setTimeout(res, 1000)); // polite delay
//     }

//     console.log(`✅ Total cases fetched: ${allCases.length}`);

//     return NextResponse.json({
//       success: true,
//       totalCount: allCases.length,
//       data: allCases,
//     });
//   } catch (error) {
//     console.error('❌ Error fetching SHC cases:', error);
//     return NextResponse.json(
//       { success: false, error: 'Failed to fetch SHC cases' },
//       { status: 500 }
//     );
//   }
// }
